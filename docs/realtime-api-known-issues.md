# Известные проблемы OpenAI Realtime API для семантического анализа

## Дата: 31.05.2025

### Проблема: Неправильное сопоставление ответов с чанками

**Описание**: При пакетной обработке чанков через Realtime API ответы не сопоставляются правильно с запросами.

**Симптомы**:
- Все чанки могут получить одинаковую семантическую функцию
- Семантические функции могут быть перепутаны между чанками

**Причина**: 
В файле `analysis/semantic_function_realtime.py`, метод `_message_handler`:
```python
if text and self.pending_requests:
    chunk_id = list(self.pending_requests.keys())[0]  # Берет ПЕРВЫЙ chunk_id!
```

**Решение**:
1. Добавить уникальный идентификатор в каждый запрос
2. Извлекать этот идентификатор из ответа для правильного сопоставления
3. Или использовать отдельные сессии для каждого чанка

### Проблема: Контекстное загрязнение

**Описание**: Одна сессия используется для всех чанков, что может приводить к "запоминанию" предыдущих ответов.

**Решение**:
- Создавать новую сессию для каждого чанка
- Или добавить инструкцию "забыть предыдущий контекст"

### Временное решение

Пока проблемы не исправлены, рекомендуется использовать REST API:
```javascript
// В frontend/my-card-view-app/src/api/index.ts
prefer_realtime=false
```

### Сравнение точности

| Метод | Точность | Скорость | Надежность |
|-------|----------|----------|------------|
| REST API | Высокая | Средняя | Высокая |
| Realtime API (текущая) | Низкая | Высокая | Средняя |

### TODO:
- [ ] Исправить сопоставление ответов с чанками
- [ ] Решить проблему контекстного загрязнения
- [ ] Добавить тесты для проверки корректности семантического анализа
- [ ] Оптимизировать батчинг для Realtime API 